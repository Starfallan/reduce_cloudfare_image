# R2 图片压缩工具

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

[English Documentation](README.md)

一个用于从Cloudflare R2存储桶下载、压缩和重新上传图片的工具，支持多种图片格式和自定义路径。

此仓库为Fork修改版，将原来的保持原格式压缩图片替换为了全部压缩为Avif格式，增加了avif格式的支持。
再次感谢原作者的付出：[Origin](https://github.com/zhangchenchen/reduce_cloudfare_image)


## 功能特点

- 从R2存储下载图片
- 支持多种输入图片格式（PNG, JPEG, WebP, GIF, AVIF）
- **将所有图片转换为 AVIF 格式以获得最佳压缩效果**
- 调整大图片尺寸（保持宽高比）
- AVIF 格式优势：
  - 比 JPEG 压缩率高 50% 以上
  - 比 WebP 压缩率高 20% 以上
  - 支持透明度和无损压缩
  - 现代浏览器广泛支持
- 将压缩后的图片上传回R2，使用 .avif 扩展名
- 并行处理多张图片
- 支持自定义目录前缀和文件匹配模式
- 包含测试模式，可以预览将处理哪些文件
- 处理前显示文件列表并请求用户确认
- 处理完成后生成详细压缩报告,并询问是否删除原来的文件。

## 安装

### 前提条件

- Python 3.6 或更高版本
- Cloudflare R2 账户，带有存储桶和访问凭证

### 设置步骤

1. 克隆仓库:
   ```bash
   git clone https://github.com/zhangchenchen/reduce_cloudfare_image.git
   cd r2-image-compression-tool
   ```

2. 安装所需包:
   ```bash
   pip install -r requirements.txt
   ```

   另：Pixi可以使用以下命令
   ```bash
   pixi install
   ```

3. 设置环境变量:
   
   **选项1: 使用环境文件**
   
   复制示例环境文件并编辑:
   ```bash
   cp env.example .env
   # 用您的凭证编辑.env文件
   ```
   
   **选项2: 使用设置脚本**
   
   复制示例设置脚本并编辑:
   ```bash
   cp set_env.sh.example set_env.sh
   # 用您的凭证编辑set_env.sh文件
   chmod +x set_env.sh
   source set_env.sh
   ```

## 使用方法

```bash
python compress_r2_images.py [选项]
```

### 命令行选项

- `--prefix PATH`: R2存储桶中要处理的目录前缀 (默认: "uiprompt/themes/")
- `--pattern REGEX`: 用于匹配文件的自定义正则表达式模式 (默认: 匹配 [前缀]/*/任意支持的图片格式)
- `--workers NUMBER`: 并行处理的工作线程数 (默认: 5)
- `--max-width PIXELS`: 调整图片后的最大宽度，单位像素 (默认: 1200)
- `--max-size SIZE_MB`: 目标最大文件大小，单位MB (默认: 1.0)
- `--avif-quality QUALITY`: AVIF压缩质量 (0-100, 默认: 85)
- `--test`: 测试模式 - 只列出将处理的文件，但不实际处理

### 示例

```bash
# 处理themes目录下的所有PNG文件
python compress_r2_images.py --prefix "2025/07/" --pattern ".*\.png$"

# 测试模式，只显示将处理的文件
python compress_r2_images.py --test --prefix "2025/07/" --pattern ".*\.png$"

# 处理特定主题目录中的所有图片
python compress_r2_images.py --prefix "themes/steampunk-game-community/" --pattern ".*\.png$"
```

### 输出示例

```
将处理以下图片文件:
+--------------------------------------------------------------+------+----------+----------+
| 文件路径                                                       | 格式   | 大小(KB)   | 大小(MB)   |
+==============================================================+======+==========+==========+
| themes/steampunk-game-community/steampunk-game-community.png | PNG  | 664.5 KB | 0.65 MB  |
+--------------------------------------------------------------+------+----------+----------+
| 总计                                                          | 1 文件 | 664.5 KB | 0.65 MB  |
+--------------------------------------------------------------+------+----------+----------+

将处理 1 个文件，总大小 0.65 MB。确认继续？(y/n): y

Processing images: 100%|████████████████████████████████████| 1/1 [00:06<00:00,  6.36s/it]

图片压缩结果报告:
+--------------------------------------------------------------+----------+----------+----------+-------+--------+
| 文件                                                           | 原始大小     | 压缩后大小    | 节省空间     | 压缩率   | 处理时间   |
+==============================================================+==========+==========+==========+=======+========+
| themes/steampunk-game-community/steampunk-game-community.png | 664.5 KB | 529.1 KB | 135.3 KB | 20.4% | 2.7s   |
+--------------------------------------------------------------+----------+----------+----------+-------+--------+
| 总计                                                           | 664.5 KB | 529.1 KB | 135.3 KB | 20.4% | -      |
+--------------------------------------------------------------+----------+----------+----------+-------+--------+
| 总计(MB)                                                       | 0.65 MB  | 0.52 MB  | 0.13 MB  | 20.4% | -      |
+--------------------------------------------------------------+----------+----------+----------+-------+--------+

共处理 1 个文件
总节省空间: 0.13 MB
平均压缩率: 20.4%
```

## 支持的图片格式

脚本支持以下**输入**图片格式:

- **PNG (.png)**: 保留透明度
- **JPEG (.jpg, .jpeg)**: 标准有损格式
- **WebP (.webp)**: 现代有损/无损格式
- **GIF (.gif)**: 动画和静态图片
- **AVIF (.avif)**: 现代高效压缩格式

**所有图片都将转换为 AVIF 格式输出**，以实现最佳的压缩效果和质量平衡。
- **AVIF (.avif)**: 高效压缩格式，支持透明度（需要系统支持AVIF编解码器）

## 工作原理

1. 列出R2存储桶中指定前缀下所有匹配模式的图片文件
2. 显示文件列表并请求用户确认
3. 下载每个图片
4. 如果图片宽度超过最大宽度，则调整大小
5. **将所有图片转换为 AVIF 格式**，应用质量优化：
   - 起始质量：可配置（默认 85）
   - 如果文件仍然过大，逐步降低质量直到符合大小要求
   - 保持透明度支持
6. 将压缩后的图片上传回R2，使用 .avif 扩展名
7. 只有当实现至少5%的大小减少时才上传
8. 生成详细的压缩报告

## 注意事项

- 运行时间取决于图片数量、大小和网络速度
- 处理进度通过进度条和日志信息显示
- 测试模式可帮助您在实际处理前预览将处理的文件
- 某些已经优化的图片可能无法进一步压缩

## 贡献

欢迎贡献！请查看 [CONTRIBUTING.md](CONTRIBUTING.md) 获取贡献指南。

## 许可证

该项目采用MIT许可证 - 详情请参阅 [LICENSE](LICENSE) 文件。 
